<!DOCTYPE html>
{% load static %}
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{% static 'main.css' %}">
    <title>Kosupure</title>
</head>

<body>
{% csrf_token %}
{% if user.is_authenticated %}
<header>
<h1>Welcome to Kosupure, {{ user.username }}!</h1>
<p><a href="{% url 'logout' %}">Logout</a><p>
</header>
{% else %}
<h1>Welcome to Kosupure, visitor!</h1>
<p>You are not logged in. <a href="{% url 'login' %}">Login</a> <a href="{% url 'users:signup' %}">Sign Up</a></p>
{% endif %}

<h1>Hello World! (From the HTML)</h1>

<div id="app">
<h1> [[ message ]] </h1>
<form :submit.prevent="submitPost()">
    <textarea class="textarea" v-model="body" placeholder="What are you thinking?"></textarea>
    <button>Submit</button>
</form>

<div v-for="post in posts">
    <p> [[ post.user ]] [[ post.created_at ]] <br> [[ post.body ]]

</div>
<script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script>
    const vm = new Vue({
        el: "#app",
        delimiters: ['[[', ']]'],
        data: {
            id: {},
            name: [],
            body: '',
            users: [],
            posts: [],
            created_at: 'Now',
            csrf_token: "",
            message: "Hello World! (From the Vue App)",
            user: [],
        },
        methods: {
            loadCurrentUser: function() {
                axios({
                    method: 'get',
                    url: '/apis/v1/currentuser/'
                }).then(response => {
                    this.user = response.data
                }),
            },
            submitPost: function() {
                if (this.body.length > 0) {
                    var post = {
                        'body': this.body,
                        'user': this.user,
                        'created_at': this.created_at,
                        }
                    this.posts.unshift(post)
                    fetch('/api/add_post/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        credentials: 'same-origin',
                        body: JSON.stringify(post)
                    })
                    .then((response) => {
                        console.log(response);
                    })
                    .catch((error) => {
                        console.log(error);
                    });
                }
                this.body = '';
            }
        },
    })
</script>
</body>